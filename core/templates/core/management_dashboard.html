{% extends "core/base.html" %}

{% block title %}Administration Dashboard - Student Attendance Management System{% endblock %}

{% block content %}
<style>
    .management-section {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
    }
    .btn-primary {
        background: #007bff;
        color: white;
    }
    .btn-primary:hover {
        background: #0056b3;
    }
    .btn-success {
        background: #28a745;
        color: white;
    }
    .btn-success:hover {
        background: #218838;
    }
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    .btn-danger:hover {
        background: #c82333;
    }
    .btn-warning {
        background: #ffc107;
        color: black;
    }
    .btn-warning:hover {
        background: #e0a800;
    }
    .management-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .management-card {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
        text-align: center;
    }
    .management-card h3 {
        margin-bottom: 10px;
        color: #333;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }
    table th, table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    table th {
        background: #f8f9fa;
        font-weight: bold;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }
    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 5px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .form-group {
        margin: 15px 0;
    }
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .action-btns {
        display: flex;
        gap: 5px;
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Administration Dashboard</h1>
        <a href="{% url 'logout-page' %}" class="btn logout-btn">Logout</a>
    </div>
    
    <div class="welcome-message">
        <h2>Welcome, {{ management_name }}!</h2>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Management ID</h3>
            <div class="stat-value">{{ management_id }}</div>
        </div>
        <div class="stat-card">
            <h3>Email</h3>
            <div class="stat-value" style="font-size: 18px;">{{ email }}</div>
        </div>
        <div class="stat-card">
            <h3>System Role</h3>
            <div class="stat-value" style="font-size: 18px;">Administrator</div>
        </div>
    </div>
    
    <div class="management-grid">
        <div class="management-card">
            <h3>Students</h3>
            <button class="btn btn-primary" onclick="showSection('students')">Manage Students</button>
        </div>
        <div class="management-card">
            <h3>Teachers</h3>
            <button class="btn btn-primary" onclick="showSection('teachers')">Manage Teachers</button>
        </div>
        <div class="management-card">
            <h3>Courses</h3>
            <button class="btn btn-primary" onclick="showSection('courses')">Manage Courses</button>
        </div>
        <div class="management-card">
            <h3>Taught Courses</h3>
            <button class="btn btn-primary" onclick="showSection('taught-courses')">Manage Taught Courses</button>
        </div>
        <div class="management-card">
            <h3>Student Enrollments</h3>
            <button class="btn btn-primary" onclick="showSection('student-courses')">Manage Enrollments</button>
        </div>
    </div>

    <!-- Students Section -->
    <div id="students-section" class="management-section" style="display: none;">
        <h2>Student Management</h2>
        <button class="btn btn-success" onclick="openAddModal('student')">Add New Student</button>
        <button class="btn btn-primary" onclick="loadStudents()">Refresh</button>
        <div id="students-list"></div>
    </div>

    <!-- Teachers Section -->
    <div id="teachers-section" class="management-section" style="display: none;">
        <h2>Teacher Management</h2>
        <button class="btn btn-success" onclick="openAddModal('teacher')">Add New Teacher</button>
        <button class="btn btn-primary" onclick="loadTeachers()">Refresh</button>
        <div id="teachers-list"></div>
    </div>

    <!-- Courses Section -->
    <div id="courses-section" class="management-section" style="display: none;">
        <h2>Course Management</h2>
        <button class="btn btn-success" onclick="openAddModal('course')">Add New Course</button>
        <button class="btn btn-primary" onclick="loadCourses()">Refresh</button>
        <div id="courses-list"></div>
    </div>

    <!-- Taught Courses Section -->
    <div id="taught-courses-section" class="management-section" style="display: none;">
        <h2>Taught Course Management</h2>
        <button class="btn btn-success" onclick="openAddModal('taught-course')">Assign Course to Teacher</button>
        <button class="btn btn-primary" onclick="loadTaughtCourses()">Refresh</button>
        <div id="taught-courses-list"></div>
    </div>

    <!-- Student Courses Section -->
    <div id="student-courses-section" class="management-section" style="display: none;">
        <h2>Student Course Enrollment Management</h2>
        <button class="btn btn-success" onclick="openAddModal('student-course')">Enroll Student in Course</button>
        <button class="btn btn-primary" onclick="loadStudentCourses()">Refresh</button>
        <div id="student-courses-list"></div>
    </div>
</div>

<!-- Generic Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">Modal</h2>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showSection(section) {
        // Hide all sections
        document.querySelectorAll('.management-section').forEach(s => s.style.display = 'none');
        
        // Show selected section
        document.getElementById(`${section}-section`).style.display = 'block';
        
        // Load data for the section
        if (section === 'students') loadStudents();
        else if (section === 'teachers') loadTeachers();
        else if (section === 'courses') loadCourses();
        else if (section === 'taught-courses') loadTaughtCourses();
        else if (section === 'student-courses') loadStudentCourses();
    }

    async function loadStudents() {
        const response = await fetch('/api/students/');
        const students = await response.json();
        
        let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Year</th><th>Dept</th><th>Section</th><th>Actions</th></tr></thead><tbody>';
        students.forEach(s => {
            html += `<tr>
                <td>${s.student_id}</td>
                <td>${s.student_name}</td>
                <td>${s.email || 'N/A'}</td>
                <td>${s.year}</td>
                <td>${s.dept}</td>
                <td>${s.section}</td>
                <td class="action-btns">
                    <button class="btn btn-warning btn-sm" onclick="editStudent(${s.student_id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.student_id}, '${s.student_name}')">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('students-list').innerHTML = html;
    }

    async function loadTeachers() {
        const response = await fetch('/api/teachers/');
        const teachers = await response.json();
        
        let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>RFID</th><th>Actions</th></tr></thead><tbody>';
        teachers.forEach(t => {
            html += `<tr>
                <td>${t.teacher_id}</td>
                <td>${t.teacher_name}</td>
                <td>${t.email || 'N/A'}</td>
                <td>${t.rfid}</td>
                <td class="action-btns">
                    <button class="btn btn-warning btn-sm" onclick="editTeacher(${t.teacher_id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTeacher(${t.teacher_id}, '${t.teacher_name}')">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('teachers-list').innerHTML = html;
    }

    async function loadCourses() {
        const response = await fetch('/api/courses/');
        const courses = await response.json();
        
        let html = '<table><thead><tr><th>ID</th><th>Course Name</th><th>Actions</th></tr></thead><tbody>';
        courses.forEach(c => {
            html += `<tr>
                <td>${c.course_id}</td>
                <td>${c.course_name}</td>
                <td class="action-btns">
                    <button class="btn btn-warning btn-sm" onclick="editCourse(${c.course_id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteCourse(${c.course_id}, '${c.course_name}')">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('courses-list').innerHTML = html;
    }

    async function loadTaughtCourses() {
        const response = await fetch('/api/taught-courses/');
        const taughtCourses = await response.json();
        
        let html = '<table><thead><tr><th>ID</th><th>Course</th><th>Teacher</th><th>Section</th><th>Year</th><th>Actions</th></tr></thead><tbody>';
        taughtCourses.forEach(tc => {
            html += `<tr>
                <td>${tc.id}</td>
                <td>${tc.course_name}</td>
                <td>${tc.teacher_name}</td>
                <td>${tc.section || 'N/A'}</td>
                <td>${tc.year || 'N/A'}</td>
                <td class="action-btns">
                    <button class="btn btn-warning btn-sm" onclick="editTaughtCourse(${tc.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTaughtCourse(${tc.id})">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('taught-courses-list').innerHTML = html;
    }

    async function loadStudentCourses() {
        const response = await fetch('/api/student-courses/');
        const studentCourses = await response.json();
        
        let html = '<table><thead><tr><th>ID</th><th>Student</th><th>Course</th><th>Teacher</th><th>Actions</th></tr></thead><tbody>';
        studentCourses.forEach(sc => {
            html += `<tr>
                <td>${sc.id}</td>
                <td>${sc.student_name}</td>
                <td>${sc.course_name}</td>
                <td>${sc.teacher_name}</td>
                <td class="action-btns">
                    <button class="btn btn-danger btn-sm" onclick="deleteStudentCourse(${sc.id})">Delete</button>
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('student-courses-list').innerHTML = html;
    }

    function openAddModal(type) {
        document.getElementById('modal').style.display = 'block';
        
        if (type === 'student') {
            document.getElementById('modal-title').textContent = 'Add New Student';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="addStudent(event)">
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" name="student_name" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>RFID:</label>
                        <input type="text" name="rfid" required>
                    </div>
                    <div class="form-group">
                        <label>Year:</label>
                        <input type="number" name="year" min="1" max="4" required>
                    </div>
                    <div class="form-group">
                        <label>Department:</label>
                        <input type="text" name="dept" required>
                    </div>
                    <div class="form-group">
                        <label>Section:</label>
                        <input type="text" name="section" required>
                    </div>
                    <button type="submit" class="btn btn-success">Add Student</button>
                </form>
            `;
        } else if (type === 'teacher') {
            document.getElementById('modal-title').textContent = 'Add New Teacher';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="addTeacher(event)">
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" name="teacher_name" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>RFID:</label>
                        <input type="text" name="rfid" required>
                    </div>
                    <button type="submit" class="btn btn-success">Add Teacher</button>
                </form>
            `;
        } else if (type === 'course') {
            document.getElementById('modal-title').textContent = 'Add New Course';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="addCourse(event)">
                    <div class="form-group">
                        <label>Course Name:</label>
                        <input type="text" name="course_name" required>
                    </div>
                    <button type="submit" class="btn btn-success">Add Course</button>
                </form>
            `;
        } else if (type === 'taught-course') {
            loadTeachersAndCoursesForForm('taught-course');
        } else if (type === 'student-course') {
            loadStudentsTeachersCoursesForForm();
        }
    }

    async function loadTeachersAndCoursesForForm(formType) {
        const [teachersRes, coursesRes] = await Promise.all([
            fetch('/api/teachers/'),
            fetch('/api/courses/')
        ]);
        const teachers = await teachersRes.json();
        const courses = await coursesRes.json();
        
        document.getElementById('modal-title').textContent = 'Assign Course to Teacher';
        document.getElementById('modal-body').innerHTML = `
            <form onsubmit="addTaughtCourse(event)">
                <div class="form-group">
                    <label>Teacher:</label>
                    <select name="teacher" required>
                        <option value="">Select Teacher</option>
                        ${teachers.map(t => `<option value="${t.teacher_id}">${t.teacher_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Course:</label>
                    <select name="course" required>
                        <option value="">Select Course</option>
                        ${courses.map(c => `<option value="${c.course_id}">${c.course_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Section:</label>
                    <input type="text" name="section" placeholder="e.g., A, B, C">
                </div>
                <div class="form-group">
                    <label>Year:</label>
                    <input type="number" name="year" min="1" max="4" placeholder="e.g., 1, 2, 3, 4">
                </div>
                <button type="submit" class="btn btn-success">Assign Course</button>
            </form>
        `;
    }

    async function loadStudentsTeachersCoursesForForm() {
        const [studentsRes, teachersRes, coursesRes] = await Promise.all([
            fetch('/api/students/'),
            fetch('/api/teachers/'),
            fetch('/api/courses/')
        ]);
        const students = await studentsRes.json();
        const teachers = await teachersRes.json();
        const courses = await coursesRes.json();
        
        document.getElementById('modal-title').textContent = 'Enroll Student in Course';
        document.getElementById('modal-body').innerHTML = `
            <form onsubmit="addStudentCourse(event)">
                <div class="form-group">
                    <label>Student:</label>
                    <select name="student" required>
                        <option value="">Select Student</option>
                        ${students.map(s => `<option value="${s.student_id}">${s.student_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Course:</label>
                    <select name="course" required>
                        <option value="">Select Course</option>
                        ${courses.map(c => `<option value="${c.course_id}">${c.course_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Teacher:</label>
                    <select name="teacher" required>
                        <option value="">Select Teacher</option>
                        ${teachers.map(t => `<option value="${t.teacher_id}">${t.teacher_name}</option>`).join('')}
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Enroll Student</button>
            </form>
        `;
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    async function addStudent(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const response = await fetch('/api/students/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Student added successfully!');
            closeModal();
            loadStudents();
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    }

    async function addTeacher(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const response = await fetch('/api/teachers/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Teacher added successfully!');
            closeModal();
            loadTeachers();
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    }

    async function addCourse(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const response = await fetch('/api/courses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Course added successfully!');
            closeModal();
            loadCourses();
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    }

    async function addTaughtCourse(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        data.classes_taken = '';
        
        const response = await fetch('/api/taught-courses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Course assigned to teacher successfully!');
            closeModal();
            loadTaughtCourses();
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    }

    async function addStudentCourse(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        data.classes_attended = '';
        
        const response = await fetch('/api/student-courses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('Student enrolled in course successfully!');
            closeModal();
            loadStudentCourses();
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    }

    async function deleteStudent(id, name) {
        if (!confirm(`Delete student "${name}"?`)) return;
        
        const response = await fetch(`/api/students/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': csrftoken}
        });
        
        if (response.ok) {
            alert('Student deleted successfully!');
            loadStudents();
        } else {
            alert('Error deleting student');
        }
    }

    async function deleteTeacher(id, name) {
        if (!confirm(`Delete teacher "${name}"?`)) return;
        
        const response = await fetch(`/api/teachers/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': csrftoken}
        });
        
        if (response.ok) {
            alert('Teacher deleted successfully!');
            loadTeachers();
        } else {
            alert('Error deleting teacher');
        }
    }

    async function deleteCourse(id, name) {
        if (!confirm(`Delete course "${name}"?`)) return;
        
        const response = await fetch(`/api/courses/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': csrftoken}
        });
        
        if (response.ok) {
            alert('Course deleted successfully!');
            loadCourses();
        } else {
            alert('Error deleting course');
        }
    }

    async function deleteTaughtCourse(id) {
        if (!confirm(`Delete this taught course assignment?`)) return;
        
        const response = await fetch(`/api/taught-courses/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': csrftoken}
        });
        
        if (response.ok) {
            alert('Taught course deleted successfully!');
            loadTaughtCourses();
        } else {
            alert('Error deleting taught course');
        }
    }

    async function deleteStudentCourse(id) {
        if (!confirm(`Delete this student enrollment?`)) return;
        
        const response = await fetch(`/api/student-courses/${id}/`, {
            method: 'DELETE',
            headers: {'X-CSRFToken': csrftoken}
        });
        
        if (response.ok) {
            alert('Student enrollment deleted successfully!');
            loadStudentCourses();
        } else {
            alert('Error deleting student enrollment');
        }
    }

    // Edit functions (simplified - you can enhance these)
    async function editStudent(id) {
        alert('Edit functionality coming soon. Use delete and re-add for now.');
    }

    async function editTeacher(id) {
        alert('Edit functionality coming soon. Use delete and re-add for now.');
    }

    async function editCourse(id) {
        alert('Edit functionality coming soon. Use delete and re-add for now.');
    }

    async function editTaughtCourse(id) {
        alert('Edit functionality coming soon. Use delete and re-add for now.');
    }
</script>
{% endblock %}
